name: kwant-api-automation

on:
  schedule:
    - cron: "15 4 * * *"
  workflow_dispatch:

jobs:
  run-api-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      COLLECTION_UID: ${{ secrets.COLLECTION_UID }}
      POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: üõí Checkout Repository
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: üì¶ Install Dependencies
        run: npm install

      - name: üìä Install Allure CLI
        run: npm install -g allure-commandline

      - name: üöÄ Run Newman Tests & Generate Report
        id: newman
        continue-on-error: true
        run: |
          npm run test 2>&1 | tee newman_output.txt || true

          # Extract stats from output
          TOTAL=$(grep "requests" newman_output.txt | grep -oP '\d+(?= ‚îÇ\s+\d+ ‚îÇ)' | head -1 || echo 0)
          FAILED_REQUESTS=$(grep "requests" newman_output.txt | grep -oP '‚îÇ\s+\d+ ‚îÇ\s+\K\d+' | head -1 || echo 0)
          FAILED_ASSERTIONS=$(grep "assertions" newman_output.txt | grep -oP '‚îÇ\s+\d+ ‚îÇ\s+\K\d+' | head -1 || echo 0)
          PASSED=$((TOTAL - FAILED_REQUESTS))
          SKIPPED=0
          SUCCESS_RATE=0

          if [[ $TOTAL -gt 0 ]]; then
            SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL) * 100}")
          fi

          TOTAL_TIME=$(grep "total run duration:" newman_output.txt | grep -oP '\d+\.?\d*[a-z]+' || echo "N/A")
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED_ASSERTIONS" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "total_time=$TOTAL_TIME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

          # Save full output for AI analysis
          cat newman_output.txt > /tmp/test_output.txt

          # Verify report was generated
          if [ -d "./allure-report" ]; then
            echo "‚úÖ Allure report directory found with $(find allure-report -type f | wc -l) files"
          else
            echo "‚ö†Ô∏è No allure-report directory found!"
          fi

      - name: ü§ñ FREE AI Failure Analysis (Google Gemini)
        id: ai_analysis
        if: always()
        run: |
          FAILED="${{ steps.newman.outputs.failed }}"
          
          if [[ "$FAILED" -gt 0 ]]; then
            echo "ü§ñ Running FREE AI analysis on test failures..."
            
            # Get the test output (last 100 lines)
            TEST_OUTPUT=$(cat /tmp/test_output.txt | tail -100)
            
            # Create prompt
            PROMPT="You are an expert API test analyst. Analyze these Newman/Postman test failures and provide:

1. Root Cause (1-2 sentences)
2. Impact Level (Low/Medium/High)
3. Recommended Fix (specific and actionable)
4. Estimated Fix Time

Keep your response concise and actionable. Format as plain text, not markdown.

Test Output:
${TEST_OUTPUT}"

            # Escape for JSON properly
            PROMPT_JSON=$(jq -n --arg p "$PROMPT" '$p')
            
            # Call Gemini API (FREE - No Credit Card!)
            AI_RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
              -H 'Content-Type: application/json' \
              -d "{
                \"contents\": [{
                  \"parts\": [{
                    \"text\": $PROMPT_JSON
                  }]
                }]
              }")
            
            # Extract AI response text
            AI_TEXT=$(echo "$AI_RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "AI analysis unavailable - check API key"' | head -c 500)
            
            # Save to output
            echo "ai_insights<<EOF" >> $GITHUB_OUTPUT
            echo "$AI_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "‚úÖ FREE AI analysis completed"
          else
            echo "ai_insights=All tests passed - no analysis needed ‚úÖ" >> $GITHUB_OUTPUT
            echo "‚úÖ No failures to analyze"
          fi

      - name: üåê Deploy Allure Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: üí¨ Send Slack Notification with AI Analysis
        if: always()
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          PREVIEW_URL="https://${{ github.repository_owner }}.github.io/${REPO_NAME}/"
          
          TOTAL="${{ steps.newman.outputs.total }}"
          PASSED="${{ steps.newman.outputs.passed }}"
          FAILED="${{ steps.newman.outputs.failed }}"
          SKIPPED="${{ steps.newman.outputs.skipped }}"
          SUCCESS_RATE="${{ steps.newman.outputs.success_rate }}"
          TOTAL_TIME="${{ steps.newman.outputs.total_time }}"
          TIMESTAMP="${{ steps.newman.outputs.timestamp }}"
          AI_INSIGHTS="${{ steps.ai_analysis.outputs.ai_insights }}"

          if [[ "$FAILED" -eq 0 && "$TOTAL" -gt 0 ]]; then
            STATUS="‚úÖ API tests completed successfully"
            COLOR="good"
          elif [[ "$TOTAL" -eq 0 ]]; then
            STATUS="‚ö†Ô∏è API tests did not run properly"
            COLOR="warning"
          else
            STATUS="üö® API Health Check tests failed"
            COLOR="danger"
          fi

          # Build fields array
          FIELDS='[
            {"title": "Total Tests", "value": "'"$TOTAL"'", "short": true},
            {"title": "‚úÖ Passed", "value": "'"$PASSED"'", "short": true},
            {"title": "‚ùå Failed", "value": "'"$FAILED"'", "short": true},
            {"title": "‚è≠Ô∏è Skipped", "value": "'"$SKIPPED"'", "short": true},
            {"title": "üìà Success Rate", "value": "'"$SUCCESS_RATE%"'", "short": true},
            {"title": "‚è≥ Total Time", "value": "'"$TOTAL_TIME"'", "short": true},
            {"title": "üïê Last Checked", "value": "'"$TIMESTAMP"'", "short": false}'
          
          # Add AI analysis field if there were failures
          if [[ "$FAILED" -gt 0 ]] && [[ -n "$AI_INSIGHTS" ]]; then
            # Escape special characters for JSON
            AI_ESCAPED=$(echo "$AI_INSIGHTS" | sed 's/"/\\"/g' | sed "s/'/\\'/g" | tr '\n' ' ')
            FIELDS="$FIELDS"',{"title": "ü§ñ AI Analysis", "value": "'"${AI_ESCAPED:0:500}"'", "short": false}'
          fi
          
          FIELDS="$FIELDS]"

          PAYLOAD=$(jq -n \
            --arg color "$COLOR" \
            --arg status "$STATUS" \
            --arg preview_url "$PREVIEW_URL" \
            --argjson fields "$FIELDS" \
            '{
              attachments: [
                {
                  color: $color,
                  title: $status,
                  fields: $fields,
                  actions: [
                    {
                      type: "button",
                      text: "View Detailed Report",
                      url: $preview_url
                    }
                  ]
                }
              ]
            }')

          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"
