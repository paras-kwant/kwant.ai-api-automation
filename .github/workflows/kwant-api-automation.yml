name: kwant-api-automation

on:
  schedule:
    - cron: "15 4 * * *"  # Runs daily at 04:15 UTC
  workflow_dispatch:

jobs:
  run-api-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      COLLECTION_UID: ${{ secrets.COLLECTION_UID }}
      POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      GH_PAGES_BRANCH: gh-pages

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: üõí Checkout Repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node.js
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install Dependencies
      - name: üì¶ Install Dependencies
        run: npm install

      # 4Ô∏è‚É£ Configure Git user (for gh-pages deployment)
      - name: üìù Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 5Ô∏è‚É£ Run API Automation Tests
      - name: üöÄ Run Newman Tests
        id: newman
        continue-on-error: true
        run: |
          node index.js | tee newman_output.txt

          # Extract stats from Newman output
          TOTAL=$(grep "Total requests:" newman_output.txt | grep -oP '\d+' | head -1 || echo 0)
          FAILED=$(grep "Failed assertions:" newman_output.txt | grep -oP '\d+' | head -1 || echo 0)
          PASSED=$((TOTAL - FAILED))
          SKIPPED=0
          SUCCESS_RATE=0

          if [[ $TOTAL -gt 0 ]]; then
            SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED/$TOTAL) * 100}")
          fi

          TOTAL_TIME=$(grep -o "completed in .*" newman_output.txt | awk '{print $3}' || echo "N/A")
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "total_time=$TOTAL_TIME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      # 6Ô∏è‚É£ Deploy Allure Report to GitHub Pages
      - name: üåç Deploy Allure Report to GitHub Pages
        if: always()
        run: |
          npm install --global gh-pages
          if [ -d "./allure-report" ]; then
            gh-pages -d ./allure-report -b $GH_PAGES_BRANCH -r https://github.com/${{ github.repository }}.git
            echo "‚úÖ Allure report deployed to GitHub Pages: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          else
            echo "‚ö†Ô∏è allure-report folder not found, skipping deployment"
          fi

      # 7Ô∏è‚É£ Send Slack Notification
      - name: üí¨ Send Slack Notification
        if: always()
        run: |
          TOTAL="${{ steps.newman.outputs.total }}"
          PASSED="${{ steps.newman.outputs.passed }}"
          FAILED="${{ steps.newman.outputs.failed }}"
          SKIPPED="${{ steps.newman.outputs.skipped }}"
          SUCCESS_RATE="${{ steps.newman.outputs.success_rate }}"
          TOTAL_TIME="${{ steps.newman.outputs.total_time }}"
          TIMESTAMP="${{ steps.newman.outputs.timestamp }}"

          if [[ "$FAILED" -eq 0 && "$TOTAL" -gt 0 ]]; then
            STATUS="‚úÖ API tests completed successfully"
            COLOR="good"
          elif [[ "$TOTAL" -eq 0 ]]; then
            STATUS="‚ö†Ô∏è API tests did not run properly"
            COLOR="warning"
          else
            STATUS="üö® PROD Health Check tests failed"
            COLOR="danger"
          fi

          PAYLOAD=$(jq -n \
            --arg color "$COLOR" \
            --arg status "$STATUS" \
            --arg total "$TOTAL" \
            --arg passed "$PASSED" \
            --arg failed "$FAILED" \
            --arg skipped "$SKIPPED" \
            --arg success_rate "$SUCCESS_RATE%" \
            --arg total_time "$TOTAL_TIME" \
            --arg timestamp "$TIMESTAMP" \
            '{
              attachments: [
                {
                  color: $color,
                  title: $status,
                  fields: [
                    {title: "Total Tests", value: $total, short: true},
                    {title: "‚úÖ Passed", value: $passed, short: true},
                    {title: "‚ùå Failed", value: $failed, short: true},
                    {title: "‚è≠Ô∏è Skipped", value: $skipped, short: true},
                    {title: "üìà Success Rate", value: $success_rate, short: true},
                    {title: "‚è≥ Total Time", value: $total_time, short: true},
                    {title: "üïê Last Checked", value: $timestamp, short: false}
                  ],
                  actions: [
                    {
                      type: "button",
                      text: "View Detailed Report",
                      url: "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
                    }
                  ]
                }
              ]
            }')

          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"
